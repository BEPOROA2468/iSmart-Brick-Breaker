<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iSmart Brick Breaker</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- গেম UI -->
<div id="game-container">
    <div id="hud">
        <span>Score: <span id="score">0</span></span>
        <span>Level: <span id="level">1</span></span>
        <span>Lives: <span id="lives">3</span></span>
        <span>Balance: <span id="balance">0</span> coins</span>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="buttons">
        <button id="startGame">Start Game</button>
        <button id="newGame">New Game</button>
        <button id="watchAd">Watch Ad</button>
        <button id="profileBtn">Profile</button>
        <button id="withdrawBtn">Withdraw</button>
    </div>
</div>

<!-- Withdraw Modal -->
<div id="withdrawModal" style="display:none;">
    <h3>Withdraw</h3>
    <input type="number" id="w_amount" placeholder="Amount in coins">
    <input type="text" id="w_account" placeholder="Wallet/Account">
    <select id="w_method">
        <option value="bkash">bKash</option>
        <option value="nagad">Nagad</option>
        <option value="paypal">Binance Pay</option>
    </select>
    <button id="submitWithdrawBtn">Submit</button>
</div>

<script>
const API_BASE = 'https://ismart-backend-dpoy.onrender.com'; // তোমার Render URL
let AUTH_TOKEN = '';

// Telegram Auth Load
async function serverAuth() {
    const wa = window.Telegram && window.Telegram.WebApp;
    if (!wa || !wa.initData) return;

    const r = await fetch(API_BASE + '/api/auth', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ initData: wa.initData })
    });
    const data = await r.json();
    if (data.token) {
        AUTH_TOKEN = data.token;
        const me = await fetch(API_BASE + '/api/me', {
            headers: { Authorization: 'Bearer ' + AUTH_TOKEN }
        }).then(r => r.json());
        document.getElementById('balance').textContent = me.balance;
    }
}
serverAuth();

// 3.3 Reward Function
async function rewardFromServer() {
    if(!AUTH_TOKEN){ alert('Open in Telegram to earn.'); return; }
    const r = await fetch(API_BASE + '/api/reward/ad', {
        method:'POST',
        headers:{ Authorization:'Bearer ' + AUTH_TOKEN }
    });
    const data = await r.json();
    if(r.ok){
        document.getElementById('balance').textContent = data.balance;
    } else {
        if(data.error==='cooldown') alert('Wait '+data.left+'s');
        else alert('Failed: '+data.error);
    }
}

// Watch Ad Button
document.getElementById('watchAd').onclick = async () => {
    // এখানে তোমার এড দেখানোর কোড থাকবে
    let ok = true; // ad দেখানোর পর true হলে কয়েন যোগ হবে
    if(ok){
        await rewardFromServer();
    }
};

// 3.4 Withdraw Function
document.getElementById('submitWithdrawBtn').onclick = async ()=>{
    if(!AUTH_TOKEN) { alert('Open in Telegram to withdraw.'); return; }
    const amt = Number(document.getElementById('w_amount').value||'0');
    const method = document.getElementById('w_method').value;
    const account = document.getElementById('w_account').value.trim();
    if(!account) return alert('Enter account/wallet');

    const r = await fetch(API_BASE + '/api/withdraw', {
        method:'POST',
        headers:{
            'Content-Type':'application/json',
            Authorization:'Bearer ' + AUTH_TOKEN
        },
        body: JSON.stringify({ method, account, amount_coins: amt })
    });
    const data = await r.json();
    if(r.ok){
        alert('Withdraw request submitted!');
        withdrawModal.style.display='none';
        const me = await fetch(API_BASE + '/api/me', { 
            headers:{ Authorization:'Bearer '+AUTH_TOKEN }
        }).then(r=>r.json());
        document.getElementById('balance').textContent = me.balance;
    } else {
        alert('Failed: ' + data.error);
    }
};
</script>

<script src="game.js"></script>
</body>
</html>
